<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ–æ–ø–æ—Ä—Ç–∞–ª ‚Äî –ó–∞–ø–∞–¥–Ω–∞—è –°–∏–±–∏—Ä—å</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üó∫</text></svg>">
    
    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #f4f6f8;
            --bg-secondary: #ffffff;
            --bg-tertiary: #eef2f5;
            --accent: #5a8fa8;
            --accent-hover: #818cf8;
            --text-primary: #2c3e50;
            --text-secondary: #5a6c7d;
            --text-muted: #8899a6;
            --border: #c5ced6;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
        }
        
        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .header {
            height: 56px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            flex-shrink: 0;
        }
        
        .logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        .logo-subtitle {
            margin-left: 12px;
            font-size: 0.875rem;
            color: var(--text-muted);
        }
        
        .header-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }
        
        .header-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: #8899a6;
            padding: 8px 16px;
            border-radius: 2px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .header-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* Sidebar */
        .sidebar {
            width: 420px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease, width 0.3s ease;
            overflow: hidden;
        }
        
        .sidebar.collapsed {
            width: 0;
            border-right: none;
        }
        
        .sidebar-toggle {
            position: absolute;
            left: 420px;
            top: 70px;
            z-index: 1000;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-left: none;
            border-radius: 0 8px 8px 0;
            padding: 12px 8px;
            cursor: pointer;
            color: #8899a6;
            transition: left 0.3s ease;
        }
        
        .sidebar.collapsed ~ .sidebar-toggle {
            left: 0;
        }
        
        .sidebar-toggle:hover {
            background: var(--accent);
            color: white;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--bg-tertiary);
        }
        
        .tab {
            flex: 1;
            padding: 14px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .tab:hover {
            color: #8899a6;
        }
        
        .tab.active {
            color: var(--accent);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent);
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        /* Project Info */
        .project-info h1 {
            color: #5a6c7d;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 12px;
            line-height: 1.3;
        }
        .project-info p {
            color: #8899a6;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .feature-panel {
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .feature-back {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-tertiary);
            border: none;
            color: #8899a6;
            padding: 10px 14px;
            border-radius: 2px;
            font-size: 0.875rem;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.2s;
        }
        
        .feature-back:hover {
            background: var(--accent);
            color: white;
        }
        
        .feature-image {
            width: 100%;
            border-radius: 4px;
            margin-bottom: 16px;
            max-height: 300px;
            object-fit: cover;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .feature-image:hover {
            opacity: 0.9;
        }
        
        .feature-image-placeholder {
            width: 100%;
            height: 180px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
        }
        
        .feature-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1.3;
        }
        
        .feature-subtitle {
            color: var(--accent);
            font-size: 0.95rem;
            margin-bottom: 16px;
            font-weight: 500;
        }
        
        .feature-description {
            color: #8899a6;
            font-size: 0.95rem;
            line-height: 1.8;
            margin-bottom: 20px;
        }
        
        .feature-description p {
            margin-bottom: 12px;
        }
        
        .feature-description h2, .feature-description h3 {
            color: var(--text-primary);
            margin: 20px 0 10px;
        }
        
        .feature-description ul, .feature-description ol {
            margin-left: 20px;
            margin-bottom: 12px;
        }
        
        .feature-description img {
            max-width: 100%;
            border-radius: 2px;
            margin: 12px 0;
        }
        
        /* Gallery */
        .feature-gallery {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 20px;
        }
        
        .gallery-thumb {
            aspect-ratio: 1;
            border-radius: 2px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
        }
        
        .gallery-thumb:hover {
            opacity: 0.8;
        }
        
        /* Lightbox */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .lightbox-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
        }
        
        .lightbox-image {
            max-width: 90vw;
            max-height: 85vh;
            object-fit: contain;
            border-radius: 2px;
        }
        
        .lightbox-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            padding: 10px;
        }
        
        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            padding: 20px 15px;
            border-radius: 2px;
            transition: background 0.2s;
        }
        
        .lightbox-nav:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .lightbox-nav.prev {
            left: -60px;
        }
        
        .lightbox-nav.next {
            right: -60px;
        }
        
        .lightbox-caption {
            text-align: center;
            color: #8899a6;
            margin-top: 12px;
            font-size: 0.9rem;
        }
        
        .lightbox-counter {
            text-align: center;
            color: var(--text-muted);
            margin-top: 8px;
            font-size: 0.8rem;
        }
        
        /* Attributes Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1500;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }
        
        .modal {
            background: var(--bg-secondary);
            border-radius: 4px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 4px 8px;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }
        
        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }
        
        .attr-row {
            display: flex;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .attr-row:last-child {
            border-bottom: none;
        }
        
        .attr-name {
            width: 40%;
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        
        .attr-value {
            width: 60%;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 500;
            word-break: break-word;
        }
        
        /* Map Tools */
        .map-tools {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .map-tool-btn {
            width: 40px;
            height: 40px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 2px;
            color: #8899a6;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.2s;
            position: relative;
        }
        
        .map-tool-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .map-tool-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        .map-tool-btn::after {
            content: attr(title);
            position: absolute;
            left: 50px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 6px 10px;
            border-radius: 2px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        
        .map-tool-btn:hover::after {
            opacity: 1;
        }
        
        /* Show Attributes Button in Panel */
        .show-attrs-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: #8899a6;
            padding: 10px 14px;
            border-radius: 2px;
            font-size: 0.85rem;
            cursor: pointer;
            margin-top: 16px;
            transition: all 0.2s;
        }
        
        .show-attrs-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        
        /* Layer List */
        .layer-group-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 12px;
            margin-top: 20px;
        }
        
        .layer-group-title:first-child {
            margin-top: 0;
        }
        
        .layer-card {
            background: #eef2f5;
            border-radius: 3px;
            padding: 14px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        
        .layer-card:hover {
            border-color: var(--border);
        }
        
        .layer-card.active {
            border-color: var(--accent);
        }
        
        .layer-header {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .layer-checkbox {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
            cursor: pointer;
        }
        
        .layer-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            flex-shrink: 0;
        }
        
        .layer-title {
            flex: 1;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .layer-count {
            font-size: 0.75rem;
            color: var(--text-muted);
            background: var(--bg-secondary);
            padding: 3px 8px;
            border-radius: 3px;
        }
        
        .layer-meta {
            margin-top: 8px;
            font-size: 0.8rem;
            color: var(--text-muted);
            line-height: 1.4;
        }
        
        .layer-badge {
            display: inline-block;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-muted);
            margin-right: 6px;
        }
        
        /* Map */
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            cursor: crosshair;
        }
        
        /* Basemap Control */
        .basemap-control {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        
        .basemap-toggle {
            background: #ffffff;
            border: 1px solid #c5ced6;
            border-radius: 3px;
            padding: 10px 14px;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .basemap-toggle:hover {
            background: var(--bg-tertiary);
        }
        
        .basemap-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: #ffffff;
            border: 1px solid #c5ced6;
            border-radius: 3px;
            padding: 8px 0;
            min-width: 180px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .basemap-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            cursor: pointer;
            color: #8899a6;
            font-size: 0.9rem;
        }
        
        .basemap-option:hover {
            background: var(--bg-tertiary);
        }
        
        .basemap-option.active {
            color: var(--accent);
        }
        
        .basemap-option .check {
            width: 18px;
        }
        
        .basemap-btn {
            width: 36px;
            height: 36px;
            border: 2px solid transparent;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .basemap-btn.active {
            border-color: var(--accent);
        }
        
        .basemap-btn::after {
            content: attr(title);
            position: absolute;
            right: 45px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        
        .basemap-btn:hover::after {
            opacity: 1;
        }
        
        .basemap-btn[data-basemap="osm"] { background: linear-gradient(135deg, #b5d29c 0%, #aad3df 100%); }
        .basemap-btn[data-basemap="satellite"] { background: linear-gradient(135deg, #1a3a2a 0%, #2d4a3e 100%); }
        .basemap-btn[data-basemap="topo"] { background: linear-gradient(135deg, #e8d4a8 0%, #c9b896 100%); }
        
        /* Coordinates */
        .coords-display {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 2px;
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-muted);
        }
        
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 12px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        
        
        
        /* Search */
        .search-container {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .search-input {
            width: 100%;
            padding: 12px 16px;
            background: #eef2f5;
            border: 1px solid var(--border);
            border-radius: 3px;
            color: var(--text-primary);
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .search-input:focus {
            border-color: var(--accent);
        }
        
        .search-input::placeholder {
            color: var(--text-muted);
        }
        
        .search-results {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .search-result-item {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }
        
        .search-result-item:hover {
            background: var(--bg-tertiary);
        }
        
        .search-result-title {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .search-result-layer {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        
        .search-no-results {
            padding: 20px;
            text-align: center;
            color: var(--text-muted);
        }

        
        /* Attribute Table Modal */
        .attr-table-modal {
            position: fixed;
            top: 100px;
            left: 100px;
            width: 800px;
            height: 500px;
            min-width: 400px;
            min-height: 300px;
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 4px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            resize: both;
            overflow: hidden;
        }
        
        .attr-table-header {
            cursor: move;
            user-select: none;
        }
        
        .attr-table th {
            position: sticky;
            top: 0;
            background: #eef2f5;
            padding: 0;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
            border-bottom: 1px solid var(--border);
            border-right: 1px solid var(--border);
            position: relative;
            min-width: 80px;
        }
        
        .attr-table th .th-content {
            display: block;
            padding: 10px 20px 10px 12px;
            cursor: pointer;
        }
        
        .attr-table th .th-content:hover {
            background: var(--bg-secondary);
        }
        
        .attr-table th:last-child {
            border-right: none;
        }
        
        .attr-table th .resizer {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 8px;
            cursor: col-resize;
            background: transparent;
            z-index: 10;
        }
        
        .attr-table th .resizer:hover,
        .attr-table th .resizer.resizing {
            background: var(--accent);
        }
        
        .attr-table td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            border-right: 1px solid var(--border);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .attr-table td:last-child {
            border-right: none;
        }
        
        .attr-table-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .attr-table-title {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .attr-table-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .attr-table-toolbar {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .attr-table-search {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 2px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .attr-table-count {
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        
        .attr-table-zoom-btn {
            padding: 8px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 2px;
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .attr-table-zoom-btn:hover:not(:disabled) {
            background: var(--accent);
            border-color: var(--accent);
        }
        
        .attr-table-zoom-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .attr-table-container {
            flex: 1;
            overflow: auto;
        }
        
        .attr-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        .attr-table th {
            position: sticky;
            top: 0;
            background: #eef2f5;
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            border-bottom: 1px solid var(--border);
        }
        
        .attr-table th:hover {
            background: var(--bg-secondary);
        }
        
        .attr-table td {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .attr-table tr:hover td {
            background: var(--bg-tertiary);
        }
        
        
        .attr-table tr.highlighted td {
            background: rgba(255, 200, 0, 0.3);
        }
        
        .attr-table-actions {
            display: flex;
            gap: 4px;
        }
        
        .attr-table-actions button {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
        }
        
        .attr-table-actions button:hover {
            background: var(--accent);
            color: white;
        }
        .attr-table-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(44, 62, 80, 0.4);
            z-index: 1999;
        }
        
        .layer-attr-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            margin-left: 8px;
        }
        
        .layer-attr-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* Legend */
        .map-legend {
            position: absolute;
            bottom: 50px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 3px;
            padding: 12px 16px;
            border: 1px solid var(--border);
            min-width: 150px;
        }
        
        .legend-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
            font-size: 0.85rem;
            color: #8899a6;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            flex-shrink: 0;
        }

        /* Leaflet overrides */
        .leaflet-popup-content-wrapper {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 3px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .leaflet-popup-tip {
            background: var(--bg-secondary);
        }
    
        /* Dark theme */
        body.dark-theme {
            --bg-dark: #0a0a0f;
            --bg-primary: #12121a;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #252542;
            --accent: #5a8fa8;
            --accent-light: #7eb3c9;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #334155;
            background: #12121a;
        }
        
        body.dark-theme .header {
            background: #0a0a0f;
        }
        
        body.dark-theme .sidebar {
            background: #1a1a2e;
            border-color: #334155;
        }
        
        body.dark-theme .tabs {
            background: #252542;
        }
        
        body.dark-theme .tab.active {
            background: #1a1a2e;
            color: #f1f5f9;
        }
        
        body.dark-theme .tab {
            color: #94a3b8;
        }
        
        body.dark-theme .search-input {
            background: #252542;
            border-color: #334155;
            color: #f1f5f9;
        }
        
        body.dark-theme .layer-card {
            background: #252542;
            border-color: #334155;
        }
        
        body.dark-theme .layer-card.active {
            background: #2d2d4a;
            border-color: #5a8fa8;
        }
        body.dark-theme .project-info {
            background: #1a1a2e;
            border-color: #334155;
        }
        body.dark-theme .project-info h1 {
            color: #c5ced6;
        }
        body.dark-theme .project-info p {
            color: #8899a6;
        }
        body.dark-theme .basemap-toggle,
        body.dark-theme .basemap-menu {
            background: #1a1a2e;
            border-color: #334155;
            color: #f1f5f9;
        }
        
        body.dark-theme .basemap-option {
            color: #94a3b8;
        }
        
        body.dark-theme .basemap-option:hover {
            background: #252542;
        }
        
        body.dark-theme .map-legend,
        body.dark-theme .coords-display {
            background: rgba(26, 26, 46, 0.95);
            color: #f1f5f9;
        }
        
        body.dark-theme .attr-table-modal {
            background: #1a1a2e;
            border-color: #334155;
        }
        
        body.dark-theme .attr-table th {
            background: #252542;
            color: #f1f5f9;
        }
        
        body.dark-theme .attr-table td {
            border-color: #334155;
            color: #94a3b8;
        }
        
        body.dark-theme .attr-table tr:hover td {
            background: #252542;
        }
        
        body.dark-theme .attr-table-search {
            background: #252542;
            border-color: #334155;
            color: #f1f5f9;
        }
        
        body.dark-theme .search-result-item {
            border-color: #334155;
        }
        
        body.dark-theme .search-result-item:hover {
            background: #252542;
        }
        
        .theme-toggle {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.25);
            border-radius: 2px;
            color: #ffffff;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-right: 10px;
            transition: all 0.2s;
        }
        
        .theme-toggle:hover {
            background: rgba(255,255,255,0.25);
        }

        </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        
        // ============================================================
        // Config
        // ============================================================
        const API_BASE = '';
        const GEOSERVER_WMS = '/geoserver/wms';
        const GEOSERVER_WFS = '/geoserver/wfs';
        
        const BASEMAPS = {
            osm: { 
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', 
                name: 'OSM',
                attribution: '¬© OpenStreetMap',
                icon: 'üó∫'
            },
            satellite: { 
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', 
                name: '–°–ø—É—Ç–Ω–∏–∫',
                attribution: '¬© Esri',
                icon: 'üõ∞'
            },
            topo: { 
                url: 'https://reliefwestsib.ru/tiles/topo/{z}/{x}/{y}', 
                name: '–¢–æ–ø–æ–∫–∞—Ä—Ç–∞',
                attribution: '¬© TopoMapper',
                icon: 'üèî'
            }
        };
        
        // ============================================================
        // App Component
        // ============================================================
        function App() {
            const [project, setProject] = useState(null);
            const [layers, setLayers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('info');
            const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
            const [selectedFeature, setSelectedFeature] = useState(null);
            const [featureContent, setFeatureContent] = useState(null);
            const [visibleLayers, setVisibleLayers] = useState({});
            const [currentBasemap, setCurrentBasemap] = useState('osm');
            const [coords, setCoords] = useState({ lat: 0, lng: 0 });
            const [activeTool, setActiveTool] = useState('info'); // 'info' or 'identify'
            const [showAttributesModal, setShowAttributesModal] = useState(false);
            const [lightboxImage, setLightboxImage] = useState(null);
            const [lightboxImages, setLightboxImages] = useState([]);
            const [lightboxIndex, setLightboxIndex] = useState(0);
            const [showLegend, setShowLegend] = useState(true);
            const [showBasemapMenu, setShowBasemapMenu] = useState(false);
            const [darkTheme, setDarkTheme] = useState(localStorage.getItem('darkTheme') === 'true');
            
            useEffect(() => {
                document.body.classList.toggle('dark-theme', darkTheme);
                localStorage.setItem('darkTheme', darkTheme);
            }, [darkTheme]);
            const [attributeTableLayer, setAttributeTableLayer] = useState(null);
            const [attributeTableData, setAttributeTableData] = useState([]);
            const [attrTableSort, setAttrTableSort] = useState({field: null, asc: true});
            const [attrTableFilter, setAttrTableFilter] = useState('');
            const [highlightedFeature, setHighlightedFeature] = useState(null);
            const highlightLayerRef = useRef(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [searchResults, setSearchResults] = useState([]);
            
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const basemapLayerRef = useRef(null);
            const wmsLayersRef = useRef({});
            const vectorLayersRef = useRef({});
            
            // Load data
            useEffect(() => {
                async function loadData() {
                    try {
                        const [projectsRes, layersRes] = await Promise.all([
                            fetch(`${API_BASE}/api/projects/`),
                            fetch(`${API_BASE}/api/layers/`)
                        ]);
                        
                        const projects = await projectsRes.json();
                        const layersData = await layersRes.json();
                        
                        if (projects.length > 0) {
                            setProject(projects[0]);
                        }
                        
                        setLayers(layersData);
                        
                        const visibility = {};
                        layersData.forEach(l => {
                            visibility[l.id] = l.default_visible;
                        });
                        setVisibleLayers(visibility);
                        
                        setLoading(false);
                    } catch (err) {
                        console.error('Failed to load data:', err);
                        setLoading(false);
                    }
                }
                
                loadData();
            }, []);
            
            // Initialize map
            useEffect(() => {
                if (!mapRef.current || mapInstanceRef.current) return;
                
                const map = L.map(mapRef.current, {
                    center: [64, 69],
                    zoom: 6,
                    zoomControl: true
                });
                
                basemapLayerRef.current = L.tileLayer(BASEMAPS[currentBasemap].url, {
                    attribution: BASEMAPS[currentBasemap].attribution
                }).addTo(map);
                
                map.on('mousemove', (e) => {
                    setCoords({ lat: e.latlng.lat, lng: e.latlng.lng });
                });
                
                mapInstanceRef.current = map;
                
                return () => {
                    map.remove();
                    mapInstanceRef.current = null;
                };
            }, []);
            
            // Update map center when project loads
            useEffect(() => {
                if (!mapInstanceRef.current || !project) return;
                
                mapInstanceRef.current.setView(
                    [project.center_lat, project.center_lon],
                    project.default_zoom || 6
                );
                
                if (project.default_basemap && BASEMAPS[project.default_basemap]) {
                    switchBasemap(project.default_basemap);
                }
            }, [project]);
            
            // Handle feature click
            const onFeatureClick = useCallback(async (feature, layer) => {
                const props = feature.properties || {};
                const featureId = props.gid || (feature.id ? feature.id.split('.').pop() : null);
                
                setSelectedFeature({
                    ...feature,
                    layer: layer,
                    featureId: featureId
                });
                
                // Fetch rich content
                try {
                    const contentResp = await fetch(
                        `${API_BASE}/api/features/${layer.slug}/${featureId}/`
                    );
                    if (contentResp.ok) {
                        const content = await contentResp.json();
                        setFeatureContent(content);
                    } else {
                        setFeatureContent(null);
                    }
                } catch {
                    setFeatureContent(null);
                }
                
                setActiveTab('info');
                setSidebarCollapsed(false);
            }, []);
            
            // Add/remove layers
            useEffect(() => {
                if (!mapInstanceRef.current || layers.length === 0) return;
                
                const map = mapInstanceRef.current;
                
                layers.forEach(layer => {
                    if (!layer.geoserver_layer_name) return;
                    
                    const isVisible = visibleLayers[layer.id];
                    const existingWmsLayer = wmsLayersRef.current[layer.id];
                    const existingVectorLayer = vectorLayersRef.current[layer.id];
                    
                    if (layer.geom_type === 'point') {
                        if (isVisible && !existingVectorLayer) {
                            loadWfsLayer(layer, map);
                        } else if (!isVisible && existingVectorLayer) {
                            map.removeLayer(existingVectorLayer);
                            delete vectorLayersRef.current[layer.id];
                        }
                    } else {
                        if (isVisible && !existingWmsLayer) {
                            const wmsLayer = L.tileLayer.wms(GEOSERVER_WMS, {
                                layers: layer.geoserver_layer_name,
                                format: 'image/png',
                                transparent: true,
                                opacity: layer.opacity || 1
                            }).addTo(map);
                            wmsLayersRef.current[layer.id] = wmsLayer;
                        } else if (!isVisible && existingWmsLayer) {
                            map.removeLayer(existingWmsLayer);
                            delete wmsLayersRef.current[layer.id];
                        }
                    }
                });
            }, [layers, visibleLayers, onFeatureClick]);
            
            // Load WFS layer
            const loadWfsLayer = async (layer, map) => {
                const wfsUrl = `${GEOSERVER_WFS}?service=WFS&version=1.1.0&request=GetFeature&typeName=${layer.geoserver_layer_name}&outputFormat=application/json&srsName=EPSG:4326`;
                
                try {
                    const resp = await fetch(wfsUrl);
                    const geojson = await resp.json();
                    
                    const vectorLayer = L.geoJSON(geojson, {
                        pointToLayer: (feature, latlng) => {
                            // –ò—â–µ–º —Å—Ç–∏–ª—å –ø–æ –∞—Ç—Ä–∏–±—É—Ç—É
                            let style = {
                                radius: 8,
                                fillColor: layer.fill_color || '#6366f1',
                                color: '#fff',
                                weight: 2,
                                opacity: 1,
                                fillOpacity: 0.9
                            };
                            
                            if (layer.styles && layer.styles.length > 0) {
                                const attrField = layer.styles[0].attribute_field;
                                const attrValue = String(feature.properties?.[attrField] || '');
                                const matchedStyle = layer.styles.find(s => s.attribute_value === attrValue);
                                if (matchedStyle) {
                                    style = {
                                        radius: matchedStyle.radius || 8,
                                        fillColor: matchedStyle.fill_color,
                                        color: matchedStyle.stroke_color || '#fff',
                                        weight: matchedStyle.stroke_width || 2,
                                        opacity: 1,
                                        fillOpacity: matchedStyle.fill_opacity || 0.9
                                    };
                                }
                            }
                            
                            return L.circleMarker(latlng, style);
                        },
                        onEachFeature: (feature, leafletLayer) => {
                            leafletLayer.on('click', () => {
                                onFeatureClick(feature, layer);
                            });
                            
                            const name = feature.properties?.name1 || 
                                        feature.properties?.Name || 
                                        feature.properties?.name ||
                                        `–û–±—ä–µ–∫—Ç`;
                            leafletLayer.bindTooltip(name, {
                                permanent: false,
                                direction: 'top',
                                offset: [0, -10]
                            });
                        }
                    }).addTo(map);
                    
                    vectorLayersRef.current[layer.id] = vectorLayer;
                } catch (err) {
                    console.error('Failed to load WFS layer:', err);
                }
            };
            
            // Switch basemap
            const switchBasemap = (name) => {
                if (!mapInstanceRef.current || !BASEMAPS[name]) return;
                
                const map = mapInstanceRef.current;
                
                if (basemapLayerRef.current) {
                    map.removeLayer(basemapLayerRef.current);
                }
                
                basemapLayerRef.current = L.tileLayer(BASEMAPS[name].url, {
                    attribution: BASEMAPS[name].attribution
                }).addTo(map);
                basemapLayerRef.current.bringToBack();
                setCurrentBasemap(name);
            };
            
            const toggleLayer = (layerId) => {
                setVisibleLayers(prev => ({
                    ...prev,
                    [layerId]: !prev[layerId]
                }));
            };
            
            const zoomToLayer = (layer) => {
                if (!mapInstanceRef.current) return;
                if (layer.bbox_west && layer.bbox_south && layer.bbox_east && layer.bbox_north) {
                    mapInstanceRef.current.fitBounds([
                        [layer.bbox_south, layer.bbox_west],
                        [layer.bbox_north, layer.bbox_east]
                    ], { padding: [50, 50] });
                }
            };
            
            const clearSelection = () => {
                setSelectedFeature(null);
                setFeatureContent(null);
            };
            
            // Lightbox functions
            const openLightbox = (imageUrl, allImages = [], index = 0) => {
                setLightboxImage(imageUrl);
                setLightboxImages(allImages);
                setLightboxIndex(index);
            };
            
            const closeLightbox = () => {
                setLightboxImage(null);
                setLightboxImages([]);
            };
            
            const nextImage = () => {
                if (lightboxImages.length > 0) {
                    const newIndex = (lightboxIndex + 1) % lightboxImages.length;
                    setLightboxIndex(newIndex);
                    setLightboxImage(lightboxImages[newIndex].url);
                }
            };
            
            const prevImage = () => {
                if (lightboxImages.length > 0) {
                    const newIndex = (lightboxIndex - 1 + lightboxImages.length) % lightboxImages.length;
                    setLightboxIndex(newIndex);
                    setLightboxImage(lightboxImages[newIndex].url);
                }
            };
            
            
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ç—Ä–∏–±—É—Ç–∏–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã —Å–ª–æ—è
            const highlightFeature = (row, layer) => {
                if (highlightLayerRef.current && mapInstanceRef.current) {
                    mapInstanceRef.current.removeLayer(highlightLayerRef.current);
                }
                
                const vectorLayer = vectorLayersRef.current[layer.id];
                if (!vectorLayer) return;
                
                vectorLayer.eachLayer((leafletLayer) => {
                    const props = leafletLayer.feature?.properties || {};
                    const featureId = leafletLayer.feature?.id || '';
                    
                    // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ name1, id –∏–ª–∏ feature.id
                    const match = (row.name1 && props.name1 === row.name1) ||
                                  (row.id && props.id === row.id) ||
                                  (row._id && featureId === row._id);
                    
                    if (match) { console.log("Found match, latlng:", leafletLayer.getLatLng ? leafletLayer.getLatLng() : "no getLatLng");
                        let latlng = null;
                        if (leafletLayer.getLatLng) {
                            latlng = leafletLayer.getLatLng();
                        } else if (leafletLayer.getBounds) {
                            latlng = leafletLayer.getBounds().getCenter();
                        }
                        if (!latlng) return;
                        
                        const highlight = L.circleMarker(latlng, {
                            radius: 15,
                            fillColor: '#ffcc00',
                            color: '#ff6600',
                            weight: 3,
                            opacity: 1,
                            fillOpacity: 0.5
                        }).addTo(mapInstanceRef.current);
                        highlightLayerRef.current = highlight;
                    }
                });
            };
            
            const zoomToFeature = (row, layer) => {
                const vectorLayer = vectorLayersRef.current[layer.id];
                if (!vectorLayer || !mapInstanceRef.current) return;
                
                vectorLayer.eachLayer((leafletLayer) => {
                    const props = leafletLayer.feature?.properties || {};
                    const match = (row.name1 && props.name1 === row.name1) || (row.id && props.id === row.id);
                    
                    if (match) { console.log("Found match, latlng:", leafletLayer.getLatLng ? leafletLayer.getLatLng() : "no getLatLng");
                        if (leafletLayer.getLatLng) {
                            mapInstanceRef.current.setView(leafletLayer.getLatLng(), 9);
                        } else if (leafletLayer.getBounds) {
                            mapInstanceRef.current.setView(leafletLayer.getBounds().getCenter(), 16);
                        }
                        highlightFeature(row, layer);
                    }
                });
            };
            
            const openAttributeTable = async (layer) => {
                if (!layer.geoserver_layer_name) return;
                
                const wfsUrl = `${GEOSERVER_WFS}?service=WFS&version=1.1.0&request=GetFeature&typeName=${layer.geoserver_layer_name}&outputFormat=application/json&srsName=EPSG:4326`;
                
                try {
                    const resp = await fetch(wfsUrl);
                    const geojson = await resp.json();
                    const features = geojson.features || [];
                    setAttributeTableData(features.map(f => ({...f.properties, _id: f.id})));
                    setAttributeTableLayer(layer);
                    setAttrTableFilter('');
                    setAttrTableSort({field: null, asc: true});
                } catch (err) {
                    console.error('Failed to load attribute table:', err);
                }
            };
            
            const closeAttributeTable = () => {
                setAttributeTableLayer(null);
                setAttributeTableData([]);
            };
            
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã
            const getFilteredSortedData = () => {
                let data = [...attributeTableData];
                
                // –§–∏–ª—å—Ç—Ä
                if (attrTableFilter) {
                    const q = attrTableFilter.toLowerCase();
                    data = data.filter(row => 
                        Object.values(row).some(v => 
                            v && String(v).toLowerCase().includes(q)
                        )
                    );
                }
                
                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
                if (attrTableSort.field) {
                    data.sort((a, b) => {
                        const va = a[attrTableSort.field];
                        const vb = b[attrTableSort.field];
                        if (va === vb) return 0;
                        if (va === null || va === undefined) return 1;
                        if (vb === null || vb === undefined) return -1;
                        const cmp = va < vb ? -1 : 1;
                        return attrTableSort.asc ? cmp : -cmp;
                    });
                }
                
                return data;
            };
            
            const handleSort = (field) => {
                setAttrTableSort(prev => ({
                    field,
                    asc: prev.field === field ? !prev.asc : true
                }));
            };

            // –ü–æ–∏—Å–∫ –ø–æ –æ–±—ä–µ–∫—Ç–∞–º
            const handleSearch = useCallback((query) => {
                setSearchQuery(query);
                if (!query || query.length < 2) {
                    setSearchResults([]);
                    return;
                }
                
                const results = [];
                const q = query.toLowerCase();
                
                // –ò—â–µ–º –≤–æ –≤—Å–µ—Ö –≤–µ–∫—Ç–æ—Ä–Ω—ã—Ö —Å–ª–æ—è—Ö
                Object.entries(vectorLayersRef.current).forEach(([layerId, vectorLayer]) => {
                    const layer = layers.find(l => l.id === parseInt(layerId));
                    if (!layer) return;
                    
                    vectorLayer.eachLayer((leafletLayer) => {
                        const props = leafletLayer.feature?.properties || {};
                        const name = props.name1 || props.Name || props.name || props.title || '';
                        const descr = props.descr_1 || props.descr || props.description || '';
                        
                        if (name.toLowerCase().includes(q) || descr.toLowerCase().includes(q)) {
                            results.push({
                                feature: leafletLayer.feature,
                                layer: layer,
                                leafletLayer: leafletLayer,
                                name: name || `–û–±—ä–µ–∫—Ç #${props.gid || ''}`,
                                coords: leafletLayer.getLatLng ? leafletLayer.getLatLng() : null
                            });
                        }
                    });
                });
                
                setSearchResults(results.slice(0, 20));
            }, [layers]);
            
            const handleSearchResultClick = (result) => {
                if (result.coords && mapInstanceRef.current) {
                    mapInstanceRef.current.setView(result.coords, 12);
                }
                onFeatureClick(result.feature, result.layer);
                setSearchQuery('');
                setSearchResults([]);
            };

            return (
                <div className="app">
                    <Header darkTheme={darkTheme} setDarkTheme={setDarkTheme} />
                    
                    <div className="main">
                        <aside className={`sidebar ${sidebarCollapsed ? 'collapsed' : ''}`}>
                            <div className="tabs">
                                <button 
                                    className={`tab ${activeTab === 'info' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('info')}
                                >
                                    –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                                </button>
                                <button 
                                    className={`tab ${activeTab === 'layers' ? 'active' : ''}`}
                                    onClick={() => setActiveTab('layers')}
                                >
                                    –°–ª–æ–∏ ({layers.length})
                                </button>
                            </div>
                            
                            <div className="search-container">
                                <input 
                                    type="text"
                                    className="search-input"
                                    placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –æ–±—ä–µ–∫—Ç–∞–º..."
                                    value={searchQuery}
                                    onChange={(e) => handleSearch(e.target.value)}
                                />
                            </div>
                            
                            {searchResults.length > 0 && (
                                <div className="search-results">
                                    {searchResults.map((result, idx) => (
                                        <div 
                                            key={idx} 
                                            className="search-result-item"
                                            onClick={() => handleSearchResultClick(result)}
                                        >
                                            <div className="search-result-title">{result.name}</div>
                                            <div className="search-result-layer">{result.layer.title}</div>
                                        </div>
                                    ))}
                                </div>
                            )}
                            
                            {searchQuery.length >= 2 && searchResults.length === 0 && (
                                <div className="search-no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                            )}
                            
                            <div className="sidebar-content">
                                {activeTab === 'info' && (
                                    selectedFeature ? (
                                        <FeaturePanel 
                                            feature={selectedFeature}
                                            content={featureContent}
                                            onBack={clearSelection}
                                            onShowAttributes={() => setShowAttributesModal(true)}
                                            onImageClick={openLightbox}
                                        />
                                    ) : (
                                        <ProjectInfo project={project} loading={loading} />
                                    )
                                )}
                                
                                {activeTab === 'layers' && (
                                    <LayerList 
                                        layers={layers}
                                        visibleLayers={visibleLayers}
                                        onToggle={toggleLayer}
                                        onZoom={zoomToLayer}
                                        onOpenAttrTable={openAttributeTable}
                                        loading={loading}
                                    />
                                )}
                            </div>
                        </aside>
                        
                        <button 
                            className="sidebar-toggle"
                            onClick={() => setSidebarCollapsed(!sidebarCollapsed)}
                        >
                            {sidebarCollapsed ? '‚ñ∂' : '‚óÄ'}
                        </button>
                        
                        <div className="map-container">
                            <div id="map" ref={mapRef}></div>
                            
                            <div className="basemap-control">
                                <button className="basemap-toggle" onClick={() => setShowBasemapMenu(!showBasemapMenu)}>
                                    üó∫ –ü–æ–¥–ª–æ–∂–∫–∞ ‚ñæ
                                </button>
                                {showBasemapMenu && (
                                    <div className="basemap-menu">
                                        {Object.entries(BASEMAPS).map(([key, value]) => (
                                            <div 
                                                key={key}
                                                className={`basemap-option ${currentBasemap === key ? "active" : ""}`}
                                                onClick={() => { switchBasemap(key); setShowBasemapMenu(false); }}
                                            >
                                                <span className="check">{currentBasemap === key ? "‚úì" : ""}</span>
                                                {value.name}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            
                            <div className="coords-display">
                                {coords.lat.toFixed(4)}, {coords.lng.toFixed(4)}
                            </div>
                            
                            <Legend layers={layers} visibleLayers={visibleLayers} show={showLegend} onToggle={() => setShowLegend(!showLegend)} />
                        </div>
                    </div>
                    
                    {/* Attributes Modal */}
                    {showAttributesModal && selectedFeature && (
                        <AttributesModal 
                            feature={selectedFeature}
                            onClose={() => setShowAttributesModal(false)}
                        />
                    )}
                    
                    {/* Lightbox */}
                    {lightboxImage && (
                        <Lightbox 
                            image={lightboxImage}
                            images={lightboxImages}
                            index={lightboxIndex}
                            onClose={closeLightbox}
                            onNext={nextImage}
                            onPrev={prevImage}
                        />
                    )}
                    {attributeTableLayer && (
                        <AttributeTableModal 
                            layer={attributeTableLayer}
                            data={getFilteredSortedData()}
                            filter={attrTableFilter}
                            onFilterChange={setAttrTableFilter}
                            sortState={attrTableSort}
                            onSort={handleSort}
                            onClose={closeAttributeTable}
                            onHighlight={highlightFeature}
                            onZoomTo={zoomToFeature}
                        />
                    )}
                </div>
            );
        }
        
        // ============================================================
        // Header
        // ============================================================
        function Header({ darkTheme, setDarkTheme }) {
            return (
                <header className="header">
                    <div className="logo">–ì–µ–æ–ø–æ—Ä—Ç–∞–ª</div>
                    <span className="logo-subtitle">–ó–∞–ø–∞–¥–Ω–∞—è –°–∏–±–∏—Ä—å ‚Äî –ª–µ–¥–Ω–∏–∫–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã</span>
                    <div className="header-actions">
                            <button 
                                className="theme-toggle" 
                                onClick={() => setDarkTheme(!darkTheme)}
                                title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É"
                            >
                                {darkTheme ? '‚òÄÔ∏è' : 'üåô'}
                            </button>
                        <a href="/admin/" className="header-btn">
                            ‚öô –ê–¥–º–∏–Ω–∫–∞
                        </a>
                    </div>
                </header>
            );
        }
        
        // ============================================================
        // Project Info
        // ============================================================
        function ProjectInfo({ project, loading }) {
            if (loading) {
                return (
                    <div className="loading">
                        <div className="spinner"></div>
                        <span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                );
            }
            
            if (!project) {
                return (
                    <div className="project-info">
                        <h1>–ì–µ–æ–ø–æ—Ä—Ç–∞–ª</h1>
                        <p>–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç –Ω–∞ –∫–∞—Ä—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</p>
                    </div>
                );
            }
            
            return (
                <div className="project-info">
                    <h1>{project.title}</h1>
                    <p>{project.description}</p>
                </div>
            );
        }
        
        // ============================================================
        // Feature Panel (Clean - no attributes table)
        // ============================================================
        function FeaturePanel({ feature, content, onBack, onShowAttributes, onImageClick }) {
            const props = feature.properties || {};
            
            const title = content?.title || 
                props.name1 || props.Name || props.name || props.NAME ||
                `–û–±—ä–µ–∫—Ç #${feature.featureId}`;
            
            // Build gallery images array
            const allImages = [];
            if (content?.main_image_url) {
                allImages.push({ url: content.main_image_url, caption: content.image_caption });
            }
            if (content?.gdrive_gallery) {
                content.gdrive_gallery.forEach(img => {
                    allImages.push({ url: img.url, caption: img.caption });
                });
            }
            if (content?.gallery) {
                content.gallery.forEach(img => {
                    allImages.push({ url: img.image_url, caption: img.caption });
                });
            }
            
            return (
                <div className="feature-panel">
                    <button className="feature-back" onClick={onBack}>
                        ‚Üê –ù–∞–∑–∞–¥
                    </button>
                    
                    {/* Main Image */}
                    {content?.main_image_url ? (
                        <img 
                            src={content.main_image_url} 
                            alt={title}
                            className="feature-image"
                            onClick={() => onImageClick(content.main_image_url, allImages, 0)}
                        />
                    ) : (
                        <div className="feature-image-placeholder">
                            üì∑ –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        </div>
                    )}
                    
                    {/* Title & Subtitle */}
                    <h2 className="feature-title">{title}</h2>
                    {content?.subtitle && (
                        <div className="feature-subtitle">{content.subtitle}</div>
                    )}
                    
                    {/* Description */}
                    {content?.description ? (
                        <div 
                            className="feature-description"
                            dangerouslySetInnerHTML={{ __html: content.description }}
                        />
                    ) : (
                        <p className="feature-description" style={{color: 'var(--text-muted)', fontStyle: 'italic'}}>
                            –û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ. –û—Ç–∫—Ä–æ–π—Ç–µ –∞–¥–º–∏–Ω–∫—É –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
                        </p>
                    )}
                    
                    {/* Gallery */}
                    {content?.gallery && content.gallery.length > 0 && (
                        <div className="feature-gallery">
                            {content.gallery.map((img, idx) => (
                                <img 
                                    key={idx}
                                    src={img.image_url}
                                    alt={img.caption || ''}
                                    className="gallery-thumb"
                                    onClick={() => onImageClick(img.image_url, allImages, idx + 1)}
                                />
                            ))}
                        </div>
                    )}
                    
                    {/* Show Attributes Button */}
                    <button className="show-attrs-btn" onClick={onShowAttributes}>
                        üìã –ü–æ–∫–∞–∑–∞—Ç—å –∞—Ç—Ä–∏–±—É—Ç—ã —Å–ª–æ—è
                    </button>
                </div>
            );
        }
        
        // ============================================================
        // Attributes Modal
        // ============================================================
        function AttributesModal({ feature, onClose }) {
            const props = feature.properties || {};
            
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={e => e.stopPropagation()}>
                        <div className="modal-header">
                            <span className="modal-title">
                                –ê—Ç—Ä–∏–±—É—Ç—ã —Å–ª–æ—è ¬´{feature.layer?.title}¬ª
                            </span>
                            <button className="modal-close" onClick={onClose}>√ó</button>
                        </div>
                        <div className="modal-body">
                            {Object.entries(props)
                                .filter(([key, value]) => value !== null && value !== '')
                                .map(([key, value]) => (
                                    <div className="attr-row" key={key}>
                                        <div className="attr-name">{key}</div>
                                        <div className="attr-value">{String(value)}</div>
                                    </div>
                                ))
                            }
                        </div>
                    </div>
                </div>
            );
        }
        
        // ============================================================
        // Lightbox
        // ============================================================
        function Lightbox({ image, images, index, onClose, onNext, onPrev }) {
            const currentCaption = images[index]?.caption || '';
            
            // Keyboard navigation
            useEffect(() => {
                const handleKey = (e) => {
                    if (e.key === 'Escape') onClose();
                    if (e.key === 'ArrowRight') onNext();
                    if (e.key === 'ArrowLeft') onPrev();
                };
                window.addEventListener('keydown', handleKey);
                return () => window.removeEventListener('keydown', handleKey);
            }, [onClose, onNext, onPrev]);
            
            return (
                <div className="lightbox" onClick={onClose}>
                    <div className="lightbox-content" onClick={e => e.stopPropagation()}>
                        <button className="lightbox-close" onClick={onClose}>√ó</button>
                        
                        {images.length > 1 && (
                            <>
                                <button className="lightbox-nav prev" onClick={onPrev}>‚Äπ</button>
                                <button className="lightbox-nav next" onClick={onNext}>‚Ä∫</button>
                            </>
                        )}
                        
                        <img src={image} alt="" className="lightbox-image" />
                        
                        {currentCaption && (
                            <div className="lightbox-caption">{currentCaption}</div>
                        )}
                        
                        {images.length > 1 && (
                            <div className="lightbox-counter">
                                {index + 1} / {images.length}
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        
        // ============================================================
        // Layer List
        // ============================================================
        function LayerList({ layers, visibleLayers, onToggle, onZoom, onOpenAttrTable, loading }) {
            if (loading) {
                return (
                    <div className="loading">
                        <div className="spinner"></div>
                        <span>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ—ë–≤...</span>
                    </div>
                );
            }
            
            const geomTypeLabels = {
                point: '–¢–æ—á–∫–∏',
                line: '–õ–∏–Ω–∏–∏',
                polygon: '–ü–æ–ª–∏–≥–æ–Ω—ã',
                multi: '–°–º–µ—à–∞–Ω–Ω—ã–π'
            };
            
            const vectorLayers = layers.filter(l => l.layer_type === 'vector');
            const rasterLayers = layers.filter(l => l.layer_type === 'raster');
            
            return (
                <div>
                    {vectorLayers.length > 0 && (
                        <>
                            <div className="layer-group-title">–í–µ–∫—Ç–æ—Ä–Ω—ã–µ —Å–ª–æ–∏</div>
                            {vectorLayers.map(layer => (
                                <div 
                                    key={layer.id}
                                    className={`layer-card ${visibleLayers[layer.id] ? 'active' : ''}`}
                                    onClick={() => onZoom(layer)}
                                >
                                    <div className="layer-header">
                                        <input 
                                            type="checkbox"
                                            className="layer-checkbox"
                                            checked={visibleLayers[layer.id] || false}
                                            onChange={(e) => {
                                                e.stopPropagation();
                                                onToggle(layer.id);
                                            }}
                                            onClick={(e) => e.stopPropagation()}
                                        />
                                        <span 
                                            className="layer-color" 
                                            style={{ background: layer.stroke_color }}
                                        />
                                        <span className="layer-title">{layer.title}</span>
                                        <span className="layer-count">{layer.feature_count}</span>
                                        <button className="layer-attr-btn" onClick={(e) => { e.stopPropagation(); onOpenAttrTable(layer); }} title="–¢–∞–±–ª–∏—Ü–∞ –∞—Ç—Ä–∏–±—É—Ç–æ–≤">‚äû</button>
                                    </div>
                                    <div className="layer-meta">
                                        <span className="layer-badge">
                                            {geomTypeLabels[layer.geom_type] || layer.geom_type}
                                        </span>
                                        {layer.description && layer.description.substring(0, 60) + '...'}
                                    </div>
                                </div>
                            ))}
                        </>
                    )}
                    
                    {rasterLayers.length > 0 && (
                        <>
                            <div className="layer-group-title">–†–∞—Å—Ç—Ä–æ–≤—ã–µ —Å–ª–æ–∏</div>
                            {rasterLayers.map(layer => (
                                <div 
                                    key={layer.id}
                                    className={`layer-card ${visibleLayers[layer.id] ? 'active' : ''}`}
                                >
                                    <div className="layer-header">
                                        <input 
                                            type="checkbox"
                                            className="layer-checkbox"
                                            checked={visibleLayers[layer.id] || false}
                                            onChange={() => onToggle(layer.id)}
                                        />
                                        <span className="layer-title">{layer.title}</span>
                                    </div>
                                </div>
                            ))}
                        </>
                    )}
                </div>
            );
        }
        
        
        
        // ============================================================
        // Attribute Table Modal
        // ============================================================
        function AttributeTableModal({ layer, data, filter, onFilterChange, sortState, onSort, onClose, onHighlight, onZoomTo }) {
            const [position, setPosition] = useState({ x: 100, y: 100 });
            const [selectedRow, setSelectedRow] = useState(null);
            const [isDragging, setIsDragging] = useState(false);
            const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
            const [colWidths, setColWidths] = useState({});
            const modalRef = useRef(null);
            
            if (!layer) return null;
            
            const columns = data.length > 0 ? Object.keys(data[0]).filter(k => k !== '_id') : [];
            
            const handleMouseDown = (e) => {
                if (e.target.closest('.attr-table-close') || e.target.closest('.attr-table-search')) return;
                if (e.target.classList.contains('resizer')) return;
                setIsDragging(true);
                setDragOffset({
                    x: e.clientX - position.x,
                    y: e.clientY - position.y
                });
            };
            
            useEffect(() => {
                const handleMouseMove = (e) => {
                    if (!isDragging) return;
                    setPosition({
                        x: e.clientX - dragOffset.x,
                        y: e.clientY - dragOffset.y
                    });
                };
                const handleMouseUp = () => setIsDragging(false);
                
                if (isDragging) {
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                }
                return () => {
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                };
            }, [isDragging, dragOffset]);
            
            const startResize = (col, e) => {
                e.stopPropagation();
                const startX = e.clientX;
                const startWidth = colWidths[col] || 120;
                
                const onMove = (ev) => {
                    const newWidth = Math.max(60, startWidth + ev.clientX - startX);
                    setColWidths(prev => ({ ...prev, [col]: newWidth }));
                };
                const onUp = () => {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                };
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            };
            
            return (
                <>
                    <div className="attr-table-overlay" onClick={onClose}></div>
                    <div 
                        ref={modalRef}
                        className="attr-table-modal"
                        style={{ left: position.x, top: position.y }}
                    >
                        <div className="attr-table-header" onMouseDown={handleMouseDown}>
                            <span className="attr-table-title">üìã {layer.title}</span>
                            <button className="attr-table-close" onClick={onClose}>√ó</button>
                        </div>
                        <div className="attr-table-toolbar">
                            <input 
                                type="text"
                                className="attr-table-search"
                                placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–∞–±–ª–∏—Ü–µ..."
                                value={filter}
                                onChange={(e) => onFilterChange(e.target.value)}
                            />
                            <button 
                                className="attr-table-zoom-btn"
                                disabled={selectedRow === null}
                                onClick={() => selectedRow !== null && onZoomTo(data[selectedRow], layer)}
                                title="–ü—Ä–∏–±–ª–∏–∑–∏—Ç—å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –æ–±—ä–µ–∫—Ç—É"
                            >
                                üîç –ü—Ä–∏–±–ª–∏–∑–∏—Ç—å
                            </button>
                            <span className="attr-table-count">{data.length} –∑–∞–ø–∏—Å–µ–π</span>
                        </div>
                        <div className="attr-table-container">
                            <table className="attr-table">
                                <thead>
                                    <tr>
                                        {columns.map(col => (
                                            <th key={col} style={{ width: colWidths[col] || 'auto' }}>
                                                <span className="th-content" onClick={() => onSort(col)}>
                                                    {col} {sortState.field === col ? (sortState.asc ? '‚Üë' : '‚Üì') : ''}
                                                </span>
                                                <div className="resizer" onMouseDown={(e) => startResize(col, e)}></div>
                                            </th>
                                        ))}
                                        
                                    </tr>
                                </thead>
                                <tbody>
                                    {data.map((row, idx) => (
                                        <tr 
                                            key={row._id || idx} 
                                            className={selectedRow === idx ? 'highlighted' : ''}
                                            onClick={() => { setSelectedRow(idx); onHighlight(row, layer); }}
                                        >
                                            {columns.map(col => (
                                                <td key={col} style={{ width: colWidths[col] || 'auto' }} title={row[col]}>{row[col]}</td>
                                            ))}
                                            
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </>
            );
        }
        
        // ============================================================
        // Legend Component

        // ============================================================
        function Legend({ layers, visibleLayers, show, onToggle }) {
            // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∏–ª–∏ –∏–∑ –≤–∏–¥–∏–º—ã—Ö —Å–ª–æ—ë–≤
            const legendItems = [];
            
            layers.forEach(layer => {
                if (visibleLayers[layer.id] && layer.styles && layer.styles.length > 0) {
                    layer.styles.forEach(style => {
                        legendItems.push({
                            color: style.fill_color,
                            label: style.legend_label || style.attribute_value,
                            layerTitle: layer.title
                        });
                    });
                }
            });
            
            if (legendItems.length === 0) return null;
            
            return (
                <div className="map-legend">
                    <div className="legend-header" onClick={onToggle} style={{cursor: 'pointer', display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                        <span className="legend-title" style={{margin: 0}}>–õ–µ–≥–µ–Ω–¥–∞</span>
                        <span style={{fontSize: '0.8rem'}}>{show ? '‚ñº' : '‚ñ≤'}</span>
                    </div>
                    {show && legendItems.map((item, idx) => (
                        <div key={idx} className="legend-item">
                            <span className="legend-color" style={{background: item.color}}></span>
                            <span>{item.label}</span>
                        </div>
                    ))}
                </div>
            );
        }
        
        // ============================================================
        // Render

        // ============================================================
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
